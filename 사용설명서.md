# 김프방 자동화 시스템 사용 설명서

## 📌 시스템 개요
텔레그램 봇과 구글 시트를 연동한 환전 작업 관리 시스템

---

## 🔧 시스템 정보

### 텔레그램 봇
- **Bot Token**: `8262199289:AAFUvLXT54cMz7KiMQohifyxGf1ORBqT1d8`
- **Webhook URL**: `https://kimchi-wucy.onrender.com/webhook`

### 구글 시트
- **Sheet ID**: `1zAjkBJcsPVq5hWS_B6H3JJYTXNsdKig12-P6xYErFEI`
- **Sheet URL**: [구글 시트 열기](https://docs.google.com/spreadsheets/d/1zAjkBJcsPVq5hWS_B6H3JJYTXNsdKig12-P6xYErFEI/edit)

### 서버
- **Service URL**: `https://kimchi-wucy.onrender.com`
- **Health Check**: `https://kimchi-wucy.onrender.com/health`
- **GitHub**: [doyoonkim12/kimchi](https://github.com/doyoonkim12/kimchi)

---

## 💬 텔레그램 명령어

### 0. 출금내역 데이터 업데이트 (거래소 API 연동)
```
업비트
업비트업데이트
코인원
코인원업데이트
전체업데이트
출금내역업데이트
```

**기능**:
- 업비트와 코인원 거래소에서 USDT 입금/판매/출금 데이터를 자동으로 가져옴
- 구글 시트 '출금내역' 탭에 자동으로 데이터 입력
- 평균달러 및 당일달러 자동 계산

**출력 예시**:
```
업비트 데이터 업데이트 완료
코인원 데이터 업데이트 완료
```

**주의사항**:
- 업비트/코인원 API 키가 .env 파일에 올바르게 설정되어 있어야 합니다
- API 키 발급 방법은 하단 "거래소 API 키 발급" 섹션 참조

---

### 1. 대기 상태 생성 (입금 대기)
```
계좌코드 출금금액 외화금액 종류
```

**예시**:
```
석모인 3000000 16259 홍달
킹국민 7000000 35647 홍달
```

**설명**:
- `석모인`: 계좌 코드 (구글 시트의 계좌정보에서 조회)
- `3000000`: 출금 금액 (원화)
- `16259`: 외화 금액
- `홍달`: 통화 종류 (홍달=HKD, 미달=USD)

**결과**:
```
정상등록 되었습니다.
발급코드 : 1234
```

---

### 2. 상태별 목록 조회

#### 회원 명령어
```
대기목록       - 외화입금 대기 중인 목록
진행대기목록   - 거래소 입금 대기 중인 목록
진행중         - 작업 중인 목록
정산대기       - 정산 대기 중인 목록
정산중         - 정산 진행 중인 목록
정산완료       - 정산 완료된 목록
```

#### 운영자 명령어
```
대기
진행대기
진행중
정산대기
정산중
정산완료
마무리
```

---

### 3. 코드별 조회
```
코드5632
```

**출력 예시**:
```
2025-09-26
김도윤 국민은행
국민 57020101416272
입금 7,040,419 수익 153,291
달러 4898 가격 1500
코드 5632
진행상황 완료
```

---

### 4. 이름별 조회
```
김도윤
정수진
장연호
곽성민
강경아
```

해당 사용자의 전체 작업 내역 조회

---

### 5. 상태 변경 명령어

#### 외화 입금 확인
```
5632 외화입금 16244
```
- 발급코드 + "외화입금" + 입금된 외화 금액

#### 진행 상태로 변경
```
5632 진행
```
- 발급코드 + "진행"

#### 바낸달러 입력
```
5632 4797
```
- 발급코드 + 바낸달러 금액
- 자동으로 최종달러 계산 (바낸달러 - 1)

#### 입금 처리
```
5632 입금 7040419
```
- 발급코드 + "입금" + 입금액
- 자동으로 수익 계산

#### 정산 처리
```
5632 정산 153291
```
- 발급코드 + "정산" + 정산금액

#### 정산 완료
```
5632 정산완료
김도윤 정산완료
```
- 발급코드 또는 이름 + "정산완료"

---

## 📊 작업 흐름

### 1단계: 대기 (입금 대기)
```
석모인 3000000 16259 홍달
```
→ 발급코드 생성 (예: 5632)

**구글 시트 기록**:
- 입금날짜, 이름, 플랫폼, 계좌정보, 출금, 외화, 종류, 발급코드

---

### 2단계: 진행 대기 (해외계좌 입금 확인)
```
5632 외화입금 16244
```

**운영자 출력**:
```
코드 : 5632 금액 : 16229 거래소입금요망!
```

**자동 계산**:
- HKD: 외화출금 = 외화입금 - 15
- USD: 외화출금 = 외화입금 - 2

---

### 3단계: 진행 중 (거래소 입금 완료)
```
5632 진행
```

**운영자 출력**:
```
코드 : 5632 금액 : 16229 작업중!
```

---

### 4단계: 정산 대기 (바낸달러 입력)
```
5632 4797
```

**운영자 출력**:
```
코드 : 5632, 달러 4796 가격 : 1500
국민 57020101416272 김도윤 3,000,000원 입금요망
```

**자동 계산**:
- 최종달러 = 바낸달러 - 1
- 출금내역시트에서 당일 달러 가격 조회

---

### 5단계: 정산 중 (입금 처리)
```
5632 입금 7040419
```

**운영자 출력**:
```
코드 : 5632 김도윤 153,291원 입금요망
```

**자동 계산**:
- 수익 = (최종달러 × 달러가격 - 출금) ÷ 2

---

### 6단계: 정산 완료
```
5632 정산완료
```

**출력**:
```
코드:5632 김도윤 정산완료
```

---

## 📁 구글 시트 구조

### 당일작업 시트
| 열 | 이름 | 설명 |
|----|------|------|
| A | 입금날짜 | 대기상태 생성일 |
| B | 이름 | 계좌 소유자 이름 |
| C | 플랫폼 | 거래 플랫폼 |
| D | 계좌정보 | 은행 계좌번호 |
| E | 입금 | 실제 입금액 |
| F | 출금 | 출금 금액 |
| G | 수익 | 계산된 수익금 |
| H | 수익입금 | 수익 입금액 |
| I | 정산 | 정산 상태 |
| J | 외화입금날짜 | 해외계좌 입금일 |
| K | 외화 | 외화 금액 |
| L | 외화입금 | 실제 입금된 외화 |
| M | 외화출금 | 계산된 외화출금 |
| N | 종류 | 통화 종류 (HKD, USD) |
| O | 진행여부 | 진행 상태 |
| P | 바낸달러 | 바낸 달러 금액 |
| Q | 최종달러 | 계산된 최종달러 |
| R | 발급코드 | 4자리 랜덤 코드 |
| S | 달러가격 | 당일 달러 환율 |
| T | 계좌코드 | 계좌 식별 코드 |

### 계좌정보 (W~Z 열)
| 열 | 이름 | 예시 |
|----|------|------|
| W | 이름 | 김도윤 |
| X | 플랫폼 | 국민은행 |
| Y | 계좌번호 | 국민 57020101416272 |
| Z | 계좌코드 | 킹국민 |

---

## 🔄 리빌드 기능

```
리빌드
```

**기능**:
1. 당일작업 시트의 완료된 데이터를 전체 시트로 이동
2. 각 이름별 시트에 데이터 복사
3. 당일작업 시트는 초기화

---

## ⚠️ 주의사항

1. **계좌코드**: 구글 시트 W~Z 열에 등록된 코드만 사용 가능
2. **통화 종류**:
   - `홍달`, `홍콩달러` → HKD
   - `미달`, `미국달러` → USD
3. **외화출금 자동계산**:
   - HKD: -15
   - USD: -2
4. **수익 계산**: (최종달러 × 달러가격 - 출금) ÷ 2
5. **최종달러 계산**: 바낸달러 - 1

---

## 🔑 거래소 API 키 발급

### 업비트 API 키 발급
1. 업비트 웹사이트 로그인: https://upbit.com
2. 마이페이지 → Open API 관리
3. "Open API Key 발급" 클릭
4. 필요한 권한 설정:
   - ✅ 자산 조회
   - ✅ 주문 조회
   - ✅ 입금 조회
   - ✅ 출금 조회
5. Access Key와 Secret Key 복사
6. Render 환경변수에 추가:
   - `UPBIT_ACCESS_KEY`: Access Key
   - `UPBIT_SECRET_KEY`: Secret Key

### 코인원 API 키 발급
1. 코인원 웹사이트 로그인: https://coinone.co.kr
2. 사용자 → API 관리 → 개인 API
3. "새 API 발급" 클릭
4. 필요한 권한 설정:
   - ✅ 입출금 조회
   - ✅ 주문 조회
   - ✅ 잔고 조회
5. Access Token과 Secret Key 복사
6. Render 환경변수에 추가:
   - `COINONE_ACCESS_TOKEN`: Access Token
   - `COINONE_SECRET_KEY`: Secret Key

**중요 보안 사항**:
- API 키는 절대 공개하지 마세요
- GitHub에 절대 업로드하지 마세요
- .env 파일은 .gitignore에 포함되어 있습니다
- Render 환경변수 설정 후 서비스 재시작 필요

---

## 🛠️ 관리자 작업

### 서버 상태 확인
```
https://kimchi-wucy.onrender.com/health
```

**응답**:
```json
{
  "status": "OK",
  "timestamp": "2025-10-26T03:31:29.000Z"
}
```

### Render 대시보드
- **URL**: https://dashboard.render.com/web/srv-d3udd9ogjchc73a8gj70
- **기능**: 배포 상태, 로그 확인, 수동 배포

### GitHub 저장소
- **URL**: https://github.com/doyoonkim12/kimchi
- **코드 수정**: 수정 후 자동 배포됨 (2-3분 소요)

---

## 🐛 문제 해결

### 봇이 응답하지 않을 때
1. Render 서비스 상태 확인
2. Health Check URL 접속
3. 필요시 Render에서 수동 재배포

### 계좌코드 오류
```
등록을 실패하였습니다. (계좌코드 오류)
```
→ 구글 시트 W~Z 열에 해당 계좌코드 등록 확인

### 형식 오류
```
등록을 실패하였습니다. (형식오류)
```
→ 명령어 형식 확인 (띄어쓰기, 숫자 형식)

---

## 📞 지원

문제 발생 시:
1. Render 로그 확인
2. 구글 시트 데이터 확인
3. GitHub Issues 제보

---

## 📊 출금내역 시트 구조

### 업비트 데이터 (A~G 열)
| 열 | 이름 | 설명 |
|----|------|------|
| A | 입금날짜 | USDT 입금 완료된 날짜 |
| B | 입금달러 | USDT 입금된 달러 금액 |
| C | 판매달러 | 완전히 체결된 판매 달러 (분할체결 제외) |
| D | 판매금액 | 판매 완료된 한화 금액 |
| E | 출금날짜 | KRW 출금한 날짜 |
| F | 출금액 | 출금한 금액 |
| G | 평균달러 | 당일 출금액 / 판매달러 |

### 코인원 데이터 (I~O 열)
| 열 | 이름 | 설명 |
|----|------|------|
| I | 입금날짜 | USDT 입금 완료된 날짜 |
| J | 입금달러 | USDT 입금된 달러 금액 |
| K | 판매달러 | 완전히 체결된 판매 달러 (분할체결 제외) |
| L | 판매금액 | 판매 완료된 한화 금액 |
| M | 출금날짜 | KRW 출금한 날짜 |
| N | 출금액 | 출금한 금액 |
| O | 평균달러 | 당일 출금액 / 판매달러 |

### 당일달러 (P 열)
| 열 | 이름 | 계산 방식 |
|----|------|----------|
| P | 당일달러 | (업비트 평균달러 + 코인원 평균달러) / 2 |

**자동 계산 로직**:
- 업비트와 코인원 양쪽 데이터가 있으면: 평균값
- 한쪽 데이터만 있으면: 해당 거래소 평균달러 사용
- 당일작업 시트에서 달러가격 조회 시 이 값을 사용

---

**마지막 업데이트**: 2025-10-26
**버전**: 2.0.0 (거래소 API 연동 추가)
